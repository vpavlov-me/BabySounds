name: ðŸŽ iOS Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  swiftlint:
    name: ðŸ” SwiftLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SwiftLint
        uses: norio-nomura/action-swiftlint@3.2.1
        continue-on-error: true
        with:
          args: --config .swiftlint.yml
        # TODO: Re-enable --strict mode and remove continue-on-error after fixing violations (Issue #23)

  build-and-test:
    name: ðŸ”¨ Build & Test
    runs-on: macos-14
    needs: swiftlint
    timeout-minutes: 45

    strategy:
      matrix:
        destination:
          - 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5'
          - 'platform=iOS Simulator,name=iPhone SE (3rd generation),OS=17.5'
          - 'platform=iOS Simulator,name=iPad (10th generation),OS=17.5'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Git LFS
        run: git lfs pull

      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Show available simulators
        run: xcrun simctl list devices available

      - name: Cache Swift Package Manager dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm/
            ~/.swiftpm/
            .swiftpm/
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Cache Xcode build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build/
          key: ${{ runner.os }}-xcode-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-xcode-

      - name: Install dependencies
        run: |
          brew list swiftlint &>/dev/null || brew install swiftlint
          brew list swiftformat &>/dev/null || brew install swiftformat

      - name: Run SwiftFormat check
        run: |
          swiftformat --config .swiftformat --lint .
          echo "âœ… SwiftFormat check passed"

      - name: Clean build folder
        run: |
          rm -rf ~/Library/Developer/Xcode/DerivedData/BabySounds*
          xcodebuild clean -workspace BabySounds.xcworkspace -scheme BabySoundsApp

      - name: Build project
        run: |
          xcodebuild build \
            -workspace BabySounds.xcworkspace \
            -scheme BabySoundsApp \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty

      - name: Run unit tests
        run: |
          xcodebuild test \
            -workspace BabySounds.xcworkspace \
            -scheme BabySoundsApp \
            -destination '${{ matrix.destination }}' \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty

      - name: Generate code coverage report
        if: matrix.destination == 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5'
        run: |
          xcrun xccov view --report --json build/DerivedData/Logs/Test/*.xcresult > coverage.json
          echo "ðŸ“Š Code coverage report generated"

      - name: Upload coverage to Codecov
        if: matrix.destination == 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5'
        uses: codecov/codecov-action@v5
        with:
          file: coverage.json
          flags: ios
          name: BabySounds iOS Coverage

      - name: Archive build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.destination }}
          path: |
            build/DerivedData/Logs/
            ~/Library/Developer/Xcode/DerivedData/BabySounds*/Logs/
          retention-days: 7

  build-release:
    name: ðŸš€ Release Build
    runs-on: macos-14
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Git LFS
        run: git lfs pull

      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_15.4.app/Contents/Developer

      - name: Cache Swift Package Manager dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm/
            ~/.swiftpm/
            .swiftpm/
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build release archive
        run: |
          xcodebuild archive \
            -workspace BabySounds.xcworkspace \
            -scheme BabySoundsApp \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/BabySounds.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: build/BabySounds.xcarchive
          retention-days: 30

  analyze-code:
    name: ðŸ“Š Code Analysis
    runs-on: macos-14
    needs: swiftlint
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_15.4.app/Contents/Developer

      - name: Run static analysis
        run: |
          xcodebuild analyze \
            -workspace BabySounds.xcworkspace \
            -scheme BabySoundsApp \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Count lines of code
        run: |
          echo "ðŸ“Š Code Statistics"
          echo "=================="
          find BabySounds -name "*.swift" | wc -l | xargs echo "Swift files:"
          find BabySounds -name "*.swift" -exec wc -l {} + | tail -1 | awk '{print "Total lines: " $1}'
          echo "Excluding tests and generated code:"
          find BabySounds -name "*.swift" -not -path "*/Tests/*" -not -name "*Generated*" -exec wc -l {} + | tail -1 | awk '{print "Source lines: " $1}'

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  accessibility-check:
    name: â™¿ Accessibility Check
    runs-on: macos-14
    needs: build-and-test
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_15.4.app/Contents/Developer

      - name: Run accessibility audit
        run: |
          echo "ðŸ” Checking for accessibility requirements..."
          # Check for accessibility identifiers
          grep -r "accessibilityIdentifier" BabySounds/ || echo "âš ï¸  No accessibility identifiers found"
          # Check for accessibility labels
          grep -r "accessibilityLabel" BabySounds/ || echo "âš ï¸  No accessibility labels found"
          # Check for accessibility hints
          grep -r "accessibilityHint" BabySounds/ || echo "â„¹ï¸  Consider adding accessibility hints"
          echo "âœ… Accessibility check completed"

  kids-compliance-check:
    name: ðŸ‘¶ Kids App Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Kids Category compliance
        run: |
          echo "ðŸ” Checking Kids Category compliance..."
          
          # Check for parental gate implementation
          if grep -r "ParentGateManager\|ParentGateView" BabySounds/; then
            echo "âœ… Parental gate implementation found"
          else
            echo "âŒ Parental gate implementation missing"
            exit 1
          fi
          
          # Check for external URL protection
          if grep -r "SafeLinkWrapper" BabySounds/; then
            echo "âœ… Safe link wrapper found"
          else
            echo "âš ï¸  Consider implementing SafeLinkWrapper for external URLs"
          fi
          
          # Check for data collection restrictions
          if grep -r "Analytics\|Tracking\|PersonalData" BabySounds/; then
            echo "âš ï¸  Potential data collection found - ensure COPPA compliance"
          else
            echo "âœ… No obvious data collection patterns found"
          fi
          
          # Check for appropriate age rating indicators
          if grep -r "4+" BabySounds/ || grep -r "Ages 5 & Under" BabySounds/; then
            echo "âœ… Age rating indicators found"
          else
            echo "â„¹ï¸  Consider adding age rating indicators"
          fi
          
          echo "âœ… Kids compliance check completed"

  build-summary:
    name: ðŸ“‹ Build Summary
    runs-on: ubuntu-latest
    needs: [swiftlint, build-and-test, build-release, analyze-code, security-scan, accessibility-check, kids-compliance-check]
    if: always()

    steps:
      - name: Generate build summary
        run: |
          echo "# ðŸŽ BabySounds iOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SwiftLint | ${{ needs.swiftlint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release Build | ${{ needs.build-release.result == 'success' && 'âœ… Passed' || needs.build-release.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.analyze-code.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kids Compliance | ${{ needs.kids-compliance-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [TestFlight](https://testflight.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Kids Category Guidelines](https://developer.apple.com/app-store/kids-apps/)" >> $GITHUB_STEP_SUMMARY 