name: üöÄ Release to TestFlight

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer

jobs:
  release:
    name: üöÄ Deploy to TestFlight
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Git LFS
        run: git lfs pull

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "üì± Releasing version: $VERSION"

      - name: Validate tag format
        run: |
          if [[ ! "${{ steps.version.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format. Expected: X.Y.Z"
            exit 1
          fi
          echo "‚úÖ Version format is valid"

      - name: Select Xcode version
        run: sudo xcode-select --switch /Applications/Xcode_15.4.app/Contents/Developer

      - name: Show build environment
        run: |
          echo "üîß Build Environment"
          echo "==================="
          xcodebuild -version
          swift --version
          echo "macOS: $(sw_vers -productVersion)"
          echo "Xcode: $(xcodebuild -version | head -1)"

      - name: Cache Swift Package Manager dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm/
            ~/.swiftpm/
            .swiftpm/
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install dependencies
        run: |
          # Install Fastlane
          sudo gem install fastlane -N
          
          # Install other tools
          brew list swiftlint &>/dev/null || brew install swiftlint
          brew list swiftformat &>/dev/null || brew install swiftformat
          
          echo "‚úÖ Dependencies installed"

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 --decode > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          echo "‚úÖ App Store Connect API key configured"
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

      - name: Setup iOS certificates and provisioning profiles
        run: |
          # Create certificates directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Import certificates
          if [ ! -z "${{ secrets.IOS_DISTRIBUTION_CERTIFICATE }}" ]; then
            echo "${{ secrets.IOS_DISTRIBUTION_CERTIFICATE }}" | base64 --decode > certificate.p12
            security create-keychain -p "" build.keychain
            security import certificate.p12 -t agg -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -A
            security list-keychains -s ~/Library/Keychains/build.keychain
            security default-keychain -s ~/Library/Keychains/build.keychain
            security unlock-keychain -p "" ~/Library/Keychains/build.keychain
            security set-key-partition-list -S apple-tool:,apple: -s -k "" ~/Library/Keychains/build.keychain
            rm certificate.p12
            echo "‚úÖ Distribution certificate imported"
          fi
          
          # Import provisioning profile
          if [ ! -z "${{ secrets.IOS_PROVISIONING_PROFILE }}" ]; then
            echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
            rm profile.mobileprovision
            echo "‚úÖ Provisioning profile imported"
          fi
        env:
          IOS_DISTRIBUTION_CERTIFICATE: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}

      - name: Verify project configuration
        run: |
          # Check version in Info.plist matches tag
          PLIST_VERSION=$(plutil -extract CFBundleShortVersionString raw BabySounds/Info.plist)
          if [ "$PLIST_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "‚ö†Ô∏è  Version mismatch: Tag=${{ steps.version.outputs.version }}, Plist=$PLIST_VERSION"
            echo "Updating Info.plist to match tag..."
            plutil -replace CFBundleShortVersionString -string "${{ steps.version.outputs.version }}" BabySounds/Info.plist
          fi
          echo "‚úÖ Project configuration verified"

      - name: Run quality checks
        run: |
          echo "üîç Running pre-release quality checks..."
          
          # SwiftLint
          swiftlint lint --config .swiftlint.yml --strict
          echo "‚úÖ SwiftLint passed"
          
          # SwiftFormat check
          swiftformat --config .swiftformat --lint .
          echo "‚úÖ SwiftFormat check passed"

      - name: Run tests
        run: |
          echo "üß™ Running comprehensive test suite..."
          xcodebuild test \
            -workspace BabySoundsDemo.xcworkspace \
            -scheme BabySounds \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5' \
            -configuration Release \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty
          echo "‚úÖ All tests passed"

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG="üéâ Initial release of BabySounds iOS app!"
          else
            CHANGELOG=$(git log $LAST_TAG..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          # Create formatted changelog
          cat > CHANGELOG.md << EOF
          # üçº BabySounds ${{ steps.version.outputs.version }}
          
          ## ‚ú® What's New
          
          $CHANGELOG
          
          ## üì± Kids Category Features
          - ‚úÖ Parental gate protection
          - ‚úÖ Safe link handling  
          - ‚úÖ No data collection from children
          - ‚úÖ Age-appropriate UI design
          - ‚úÖ COPPA compliant
          
          ## üéµ Audio Features
          - Professional multi-track audio engine
          - Background playback support
          - Sleep timer and scheduling
          - WHO-compliant volume protection
          
          ## üíé Premium Features
          - Extended sound library
          - Multi-track mixing
          - Unlimited favorites
          - Advanced sleep schedules
          EOF
          
          echo "changelog_file=CHANGELOG.md" >> $GITHUB_OUTPUT
          echo "‚úÖ Changelog generated"

      - name: Build and archive
        run: |
          echo "üî® Building release archive..."
          
          # Clean build
          xcodebuild clean \
            -workspace BabySoundsDemo.xcworkspace \
            -scheme BabySounds
          
          # Build archive
          xcodebuild archive \
            -workspace BabySoundsDemo.xcworkspace \
            -scheme BabySounds \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/BabySounds.xcarchive \
            -derivedDataPath build/DerivedData \
            | xcpretty
            
          echo "‚úÖ Archive created successfully"

      - name: Export IPA
        run: |
          echo "üì¶ Exporting IPA for App Store..."
          
          # Create export options
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
              <key>manageAppVersionAndBuildNumber</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/BabySounds.xcarchive \
            -exportPath build/ \
            -exportOptionsPlist ExportOptions.plist \
            | xcpretty
            
          echo "‚úÖ IPA exported successfully"

      - name: Upload to TestFlight using Fastlane
        run: |
          echo "‚úàÔ∏è Uploading to TestFlight..."
          
          # Configure Fastlane environment
          export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_KEY_ID }}"
          export APP_STORE_CONNECT_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"
          export APP_STORE_CONNECT_API_KEY_PATH="~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8"
          
          # Upload using Fastlane
          fastlane pilot upload \
            --ipa "build/BabySounds.ipa" \
            --skip_waiting_for_build_processing false \
            --skip_submission true \
            --distribute_external false \
            --notify_external_testers false \
            --changelog "$(cat CHANGELOG.md)"
            
          echo "‚úÖ Successfully uploaded to TestFlight"
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "üçº BabySounds ${{ steps.version.outputs.version }}"
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            build/BabySounds.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify team
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Release ${{ steps.version.outputs.version }} completed successfully!"
            echo "üîó Check TestFlight: https://appstoreconnect.apple.com"
          else
            echo "‚ùå Release ${{ steps.version.outputs.version }} failed!"
          fi
          
          # Send Slack notification if webhook is configured
          if [ ! -z "${{ secrets.SLACK_WEBHOOK }}" ]; then
            STATUS_EMOJI=${{ job.status == 'success' && '‚úÖ' || '‚ùå' }}
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \"$STATUS_EMOJI BabySounds ${{ steps.version.outputs.version }} release ${{ job.status }}!\",
                \"blocks\": [{
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"$STATUS_EMOJI *BabySounds ${{ steps.version.outputs.version }}* release ${{ job.status }}!\"
                  }
                }]
              }" \
              ${{ secrets.SLACK_WEBHOOK }}
          fi
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

      - name: Cleanup
        if: always()
        run: |
          # Clean up sensitive files
          rm -f ~/private_keys/AuthKey_*.p8
          rm -f ExportOptions.plist
          security delete-keychain ~/Library/Keychains/build.keychain || true
          echo "‚úÖ Cleanup completed"

      - name: Archive build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: release-failure-logs-${{ steps.version.outputs.version }}
          path: |
            build/DerivedData/Logs/
            ~/Library/Developer/Xcode/DerivedData/BabySounds*/Logs/
            CHANGELOG.md
          retention-days: 30 